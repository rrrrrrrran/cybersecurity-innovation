# SM3 哈希算法 SIMD 优化实现

## 一、项目简介

本项目实现了基于 AVX2 SIMD 指令集的国密哈希算法 SM3 的优化版本。利用 SIMD 并行计算特性，对 SM3 算法中的消息扩展和压缩函数阶段进行向量化重构，显著提升了算法的运行效率。

---

## 二、优化报告

### 1. 算法背景

SM3 是中国国家密码管理局发布的密码杂凑算法，广泛应用于数字签名和消息认证中。其核心计算流程包括：

- 消息填充（padding）  
- 消息扩展（message expansion）  
- 压缩函数（compression function）  

---

### 2. SIMD 优化思路

#### 消息填充阶段

- 使用标量代码实现，保证数据格式正确  
- 将消息填充成 512 位的整数倍  
- 转换为大端格式的 `uint32_t` 数组，便于后续 SIMD 加载  

#### 消息扩展阶段

- 使用 AVX2 256位寄存器并行计算  
- 一次处理 8 个 `w[i]`，通过批量加载、异或、循环左移实现  
- 采用 SIMD 指令实现 P1 置换函数  
- 同时批量计算辅助数组 `w'`  
- 余数部分采用标量计算保证正确性  

#### 压缩函数阶段

- 使用 8 路 AVX2 寄存器模拟 8 条消息并行处理（单条消息模式下重复填充）  
- 每轮迭代使用 SIMD 指令批量执行布尔函数、循环左移和加法操作  
- 轮间数据依赖强，无法并行，只能提升单轮内部执行效率  
- 最终取 SIMD 寄存器中第 0 路数据更新哈希状态  

---

### 3. 优化效果总结

| 阶段       | 优化方法                     | 说明                         |
|------------|------------------------------|------------------------------|
| 消息填充   | 标量实现                     | 数据准备，格式转化           |
| 消息扩展   | AVX2批量8字并行计算          | 大幅减少循环次数和计算时间   |
| 压缩函数   | 8路AVX2寄存器并行状态变量计算 | SIMD指令减少指令数，提高吞吐 |

---

## 三、代码结构

- `messagePad()`：消息填充，转换为大端uint32_t数组  
- `messageExpand_SIMD()`：消息扩展，批量计算扩展字数组  
- `compressFunction_SIMD_single()`：压缩函数，使用SIMD寄存器并行处理64轮迭代  
- `SM3_SIMD()`：主函数，负责分块调用以上模块完成哈希计算  
- `main()`：测试函数，验证正确性并测试性能  

---

## 四、环境与编译说明

### 运行环境

- 支持 AVX2 指令集的 CPU  
- C++17 或以上标准编译器（GCC、Clang、MSVC）

### 编译命令示例

```bash
g++ -O3 -mavx2 -march=native -std=c++17 SM3.cpp -o sm3_simd
```

### 运行测试

```bash
./sm3_simd
```
### 程序输出：

```
SM3 SIMD Digest:
66c7f0f462eeedd9d1f2d46bdc10e4e24167c4875cf2f7a2297da02b8f4ba8e0
Average time per SM3_SIMD call (single message): 95.3 us
```

时间为8个消息的压缩实现。